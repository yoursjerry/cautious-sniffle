name: Watch Upstream ReVanced Releases

on:
  schedule:
    - cron: "*/15 * * * *"   # check every 15 minutes
  workflow_dispatch:

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine upstream repo
        id: upstream
        run: |
          if [ -n "$UPSTREAM_REPO" ]; then
            echo "repo=$UPSTREAM_REPO" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -f config.json ]; then
            VAL=$(grep -Eo '"upstream_repo"\s*:\s*"[^"]+' config.json | sed -E 's/.*"upstream_repo"\s*:\s*"//')
            if [ -n "$VAL" ]; then
              echo "repo=$VAL" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          if [ -f config.toml ]; then
            VAL=$(grep -E 'upstream_repo|upstream|repo' config.toml | head -n1 | sed -E 's/.*=//; s/[ "']+//g')
            if echo "$VAL" | grep -q "github.com"; then
              VAL=$(echo "$VAL" | sed -E 's#.*github.com/([^/]+/[^/]+).*#\1#')
            fi
            if [ -n "$VAL" ]; then
              echo "repo=$VAL" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          echo "repo=revanced/revanced-patches" >> "$GITHUB_OUTPUT"

      - name: Check for Upstream Updates
        id: check
        run: |
          REPO="${{ steps.upstream.outputs.repo }}"
          echo "Checking upstream: $REPO"

          LATEST=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" \
            | jq -r '.tag_name')

          if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
            echo "updated=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"

          if [ -f last_upstream.txt ]; then
            PREVIOUS=$(cat last_upstream.txt)
          else
            PREVIOUS=""
          fi

          echo "previous=$PREVIOUS" >> "$GITHUB_OUTPUT"

          if [ "$LATEST" != "$PREVIOUS" ]; then
            echo "updated=true" >> "$GITHUB_OUTPUT"
            echo "$LATEST" > last_upstream.txt
          else
            echo "updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Cached Version
        if: steps.check.outputs.updated == 'true'
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "github-actions"
          git add last_upstream.txt
          git commit -m "Update upstream version to ${{ steps.check.outputs.latest }}"
          git push

      - name: Trigger Build Workflow
        if: steps.check.outputs.updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "build.yml",
              ref: "main"
            });